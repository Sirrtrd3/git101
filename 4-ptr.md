# Pointers and Dynamic Memory Allocation


## Pointers and Addresses

- ภาษา C โปรแกรมสามารถเข้าถึงและจัดการกับข้อมูลในหน่วยความจำได้โดยตรง ด้วยการใช้ pointers
- Pointer เป็นตัวแปรที่ใช้เก็บ address ในหน่วยความจําที่ต้องการอ้างถึง
- ค่าของตำแหน่งหรือ address ในหน่วยความจําก็คือค่าจํานวนเต็มบวกที่เริ่มจาก 0

- เวลาใช้งาน pointer เพื่อเก็บค่าตำแหน่งในหน่วยความจํา ต้องระบุว่าตำแหน่งในหน่วยความจํานั้น มีการเก็บข้อมูลประเภทใดไว้


## Pointers Operators

- & ใช้หาค่าดำแหน่งในหน่วยความจําของ operand
    ```
    int c = 5;
    int *p;

    p = &c;
    printf("%d\n", c);  // c = 5
    printf("%d\n", *p); // *p = 5
    ```


## Pointers and Arrays

- อาเรย์สามารถใช้เก็บข้อมูลมากกว่า 1 จำนวนที่เป็นประเภทเดียวกันเข้าไว้ด้วยกันภายใต้ตัวแปรเดียวกันได้
- a\[i] อ้างอิงขึ้นข้อมูลตัวที่ i ในอาเรย์ a โดยข้อมูลตัวแรกในอาเรย์คือ a\[0]
- ชื่อตัวแปรอาเรย์เป็นนิพจน์ที่บอกถึงค่า base address ของอาเรย์ กล่าวคือ a จะให้ค่าตำแหน่งในหน่วยความจําที่ใช้เก็บข้อมูลตัวแรกในอาเรย์
- a และ &a\[e] ให้ค่าเท่ากัน
- *(a + i) และ a\[i] เป็นนิพจน์ที่บอกถึงสิ่งเดียวกัน


## Expressions and Pointer Arithmetic

- ตัวแปร pointer สามารถเป็น operand ให้กับนิพจน์เหล่านี้ได้
    - นิพจน์ทางคณิตศาสตร์
    - นิพจน์ในการกำหนดค่า
    - นิพจน์ในการเปรียบเทียบ
    - หากแต่ว่า ไม่ใช่ทุกตัวดำเนินการที่ใช้ในนิพจน์เหล่านี้จะสามารถใช้ร่วมกับ pointer ได้ทั้งหมด

### ความหมายของนิพจน์ที่มี pointer กับตัวดำเนินการคณิตศาสตร์

```
float f[4] = {0.0, 1.0, 2.0, 3.0};
float *pf;

pf = &f[0];
pf = pf + 2; 
```
- นิพจน์ pf = pf + 2 ไม่ได้หมายความว่าให้เพิ่มค่า pf ขึ้นไปอีก 2 หน่วย
- นิพจน์ pf = pf + 2 หมายถึงให้เพิ่มค่า pf ขึ้นไปเป็นจํานวน 2 เท่าของขนาดประเภทข้อมูลที่ pf อ้างถึง (ซึ่งในกรณีนี้ pf อ้างถึงประเภทข้อมูลที่เป็น float ซึ่งมีขนาด 4 byte)
- ดังนั้น 2 เท่าของขนาดประเภทข้อมูล float จะมีค่าเป็น 2*4 = 8 byte นั่นเอง
- นิพจน์ pf = pf + 2 จะเพิ่มค่า pf ขึ้นไปอีก 8 หน่วยนั่นเอง
- กรณีที่เป็นการลบก็เป็นในลักษณะนี้เช่นกัน


## Pointers to Function

- เราสามารถใช้ตัวแปร pointer อ้างไปยังดำแหน่งในหน่วยความจา (base address) ของฟังก์ชันที่ต้องการได้
- โดยปกติแล้ว ชื่อฟังก์ชันเป็นนิพจน์ที่ให้ค่า base address ของฟังก์ชัน (ซึ่งมีลักษณะเดียวกับอาเรย์ที่ชื่ออาเรย์เป็นนิพจน์ที่ให้ค่า base address ของอาเรย์)


## Dynamic Memory Allocation

- เป็นการจองพื้นที่ในหน่วยความจําตามขนาดที่เราต้องการในขณะที่โปรแกรมกำลังทำงานอยู่ และการคืนพื้นที่ที่เคยจองไว้หากเราไม่ได้งานอีกต่อไป
- ใช้ฟังก์ชั่น malloc() และ free() เพื่อจองและคืนพื้นที่ในหน่วยความจํา

### การใช้ malloc()

```
int *data;

data = (int *) malloc (1000 * sizeof(int));
```
- พารามิเตอร์ของ malloc() จะเป็นจํานวน byte ที่ใช้ในการจองพื้นที่
- ประเภทข้อมูลในการส่งกลับของ malloc() เป็น (void *) ดังนั้นหากเราต้องการพื้นที่เพื่อใช้จัดเก็บข้อมูลประเภทอื่น เราจำเป็นต้อง explicit cast ให้เป็นประเภทข้อมูลที่ต้องการใช้
- ค่าที่ malloc() ส่งกลับเป็น base address ที่ระบบปฏิบัติการจองพื้นที่ในหน่วยความจําไว้ให้
- หากหน่วยความจําในระบบไม่มีเพียงพอให้จองได้ malloc() จะส่งค่า NULL กลับมายังผู้เรียก

### การใช้ free()

```
free(data);
```
- พารามิเตอร์ของ free() จะเป็นค่าแหน่ง base address ที่เราต้องการคืนพื้นที่ให้กับระบบ


## Segmentation fault (core dumped)

- หากเราพยายามเข้าถึงหน่วยความจำที่เราไม่ได้จองไว้หรือหน่วยความจำที่นอกเหนือจากตัวแปรที่เราประกาศไว้ จะมีโอกาสที่จะถูกระบบปฏิบัติการจะหยุดการทำงานของโปรแกรม ในระบบ UNIX มักจะแสดงข้อความว่า Segmentation fault (core dumped) ออกมาบนหน้าจอ

